# Resource Validation


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Validation Actions

The validation system returns different actions based on resource
availability:

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-resources/blob/main/cjm_fasthtml_resources/core/validation.py#L28"
target="_blank" style="float:right; font-size:smaller">source</a>

### ValidationAction

>  ValidationAction (value, names=None, module=None, qualname=None,
>                        type=None, start=1, boundary=None)

*Actions that can be taken based on validation results.*

## Validation Result

The result object contains all information needed to make decisions
about job execution:

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-resources/blob/main/cjm_fasthtml_resources/core/validation.py#L39"
target="_blank" style="float:right; font-size:smaller">source</a>

### ValidationResult

>  ValidationResult (action:__main__.ValidationAction, can_proceed:bool,
>                        message:str, conflict:Optional[cjm_fasthtml_resources.c
>                        ore.manager.ResourceConflict]=None, current_worker:Opti
>                        onal[cjm_fasthtml_resources.core.manager.WorkerState]=N
>                        one, plugin_name_to_reload:Optional[str]=None,
>                        new_config:Optional[Dict[str,Any]]=None)

*Result of resource validation.*

``` python
# Example: Creating a validation result
result = ValidationResult(
    action=ValidationAction.PROCEED,
    can_proceed=True,
    message="GPU available. Proceeding with job."
)

print(f"Action: {result.action.value}")
print(f"Can proceed: {result.can_proceed}")
print(f"Message: {result.message}")
```

    Action: proceed
    Can proceed: True
    Message: GPU available. Proceeding with job.

## Resource Validation Function

This is the main validation function that coordinates resource checks
and returns appropriate actions.

The validation logic handles several scenarios:

1.  **CPU-based plugins**: Check system memory availability
2.  **API-based plugins**: Skip resource validation
3.  **GPU-based plugins**: Check GPU availability and handle conflicts
4.  **Plugin switching**: Detect when plugins need to be reloaded
5.  **Resource conflicts**: Identify conflicts with app workers or
    external processes

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-resources/blob/main/cjm_fasthtml_resources/core/validation.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### validate_resources_for_job

>  validate_resources_for_job (resource_manager, plugin_registry,
>                                  get_plugin_resource_requirements,
>                                  compare_plugin_resources,
>                                  get_plugin_resource_identifier,
>                                  plugin_id:str,
>                                  plugin_config:Optional[Dict[str,Any]]=None,
>                                  worker_pid:Optional[int]=None,
>                                  worker_type:str='transcription',
>                                  verbose:bool=False)

*Validate if resources are available to run a job with the specified
plugin. This function is dependency-injected with helper functions to
avoid tight coupling with specific plugin registry implementations.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>resource_manager</td>
<td></td>
<td></td>
<td>ResourceManager instance</td>
</tr>
<tr>
<td>plugin_registry</td>
<td></td>
<td></td>
<td>Plugin registry protocol (has get_plugin, load_plugin_config
methods)</td>
</tr>
<tr>
<td>get_plugin_resource_requirements</td>
<td></td>
<td></td>
<td>Function: (plugin_id, config) -&gt; Dict with requirements</td>
</tr>
<tr>
<td>compare_plugin_resources</td>
<td></td>
<td></td>
<td>Function: (config1, config2) -&gt; bool (same resource?)</td>
</tr>
<tr>
<td>get_plugin_resource_identifier</td>
<td></td>
<td></td>
<td>Function: (config) -&gt; str (resource ID)</td>
</tr>
<tr>
<td>plugin_id</td>
<td>str</td>
<td></td>
<td>Unique plugin ID</td>
</tr>
<tr>
<td>plugin_config</td>
<td>Optional</td>
<td>None</td>
<td>Plugin configuration (will load if not provided)</td>
</tr>
<tr>
<td>worker_pid</td>
<td>Optional</td>
<td>None</td>
<td>PID of the worker that will run the job (if known)</td>
</tr>
<tr>
<td>worker_type</td>
<td>str</td>
<td>transcription</td>
<td>Type of worker (e.g., “transcription”, “llm”, “ollama”)</td>
</tr>
<tr>
<td>verbose</td>
<td>bool</td>
<td>False</td>
<td>Whether to print verbose logging</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>ValidationResult</strong></td>
<td></td>
<td><strong>ValidationResult with action to take</strong></td>
</tr>
</tbody>
</table>

The validation function uses dependency injection to avoid tight
coupling. You provide helper functions that know how to work with your
specific plugin registry implementation.

## Error Handling Integration

When the `cjm-error-handling` library is installed, you can convert
[`ValidationResult`](https://cj-mills.github.io/cjm-fasthtml-resources/core/validation.html#validationresult)
objects into structured exceptions. This is useful when you want to
raise errors instead of returning result objects.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-resources/blob/main/cjm_fasthtml_resources/core/validation.py#L396"
target="_blank" style="float:right; font-size:smaller">source</a>

### validation_result_to_error

>  validation_result_to_error (result:__main__.ValidationResult,
>                                  plugin_id:Optional[str]=None,
>                                  job_id:Optional[str]=None,
>                                  worker_pid:Optional[int]=None,
>                                  **extra_context)

*Convert a ValidationResult into a structured error. Requires
cjm-error-handling library.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>result</td>
<td>ValidationResult</td>
<td></td>
<td>Validation result to convert</td>
</tr>
<tr>
<td>plugin_id</td>
<td>Optional</td>
<td>None</td>
<td>Plugin ID for error context</td>
</tr>
<tr>
<td>job_id</td>
<td>Optional</td>
<td>None</td>
<td>Job ID for error context</td>
</tr>
<tr>
<td>worker_pid</td>
<td>Optional</td>
<td>None</td>
<td>Worker PID for error context</td>
</tr>
<tr>
<td>extra_context</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>Structured error based on validation action, or None if no
error needed</strong></td>
</tr>
</tbody>
</table>

### Example: Converting ValidationResult to Errors

This shows how to use the error handling integration:

``` python
# Example 1: ABORT case (plugin not found)
if _has_error_handling:
    abort_result = ValidationResult(
        action=ValidationAction.ABORT,
        can_proceed=False,
        message="Plugin transcription_whisper_huge not found."
    )
    
    error = validation_result_to_error(
        abort_result,
        plugin_id="transcription_whisper_huge",
        job_id="job-123"
    )
    
    print("Example 1: ABORT -> ValidationError")
    print(f"  Error type: {type(error).__name__}")
    print(f"  Message: {error.get_user_message()}")
    print(f"  Retryable: {error.is_retryable}")
    print(f"  Severity: {error.severity.value}")
    print(f"  Context: plugin_id={error.context.plugin_id}, job_id={error.context.job_id}")
else:
    print("cjm-error-handling not installed - skipping example")
```

    Example 1: ABORT -> ValidationError
      Error type: ValidationError
      Message: Plugin transcription_whisper_huge not found.
      Retryable: False
      Severity: error
      Context: plugin_id=transcription_whisper_huge, job_id=job-123

``` python
# Example 2: WAIT_FOR_JOB case (GPU busy with same worker type)
if _has_error_handling:
    # Simulate a worker state
    from cjm_fasthtml_resources.core.manager import WorkerState
    
    busy_worker = WorkerState(
        pid=54321,
        worker_type="transcription",
        job_id="job-current",
        plugin_id="whisper_large",
        plugin_name="whisper_large",
        loaded_plugin_resource="openai/whisper-large-v3",
        config={"model_id": "openai/whisper-large-v3"},
        status="running"
    )
    
    wait_result = ValidationResult(
        action=ValidationAction.WAIT_FOR_JOB,
        can_proceed=False,
        message="GPU in use by running job (PID 54321). Wait for completion or cancel job.",
        current_worker=busy_worker
    )
    
    error = validation_result_to_error(
        wait_result,
        plugin_id="whisper_base",
        job_id="job-456"
    )
    
    print("\nExample 2: WAIT_FOR_JOB -> ResourceError")
    print(f"  Error type: {type(error).__name__}")
    print(f"  Message: {error.get_user_message()}")
    print(f"  Retryable: {error.is_retryable}")
    print(f"  Resource type: {error.resource_type}")
    print(f"  Suggested action: {error.suggested_action}")
    print(f"  Context worker PID: {error.context.worker_pid}")
else:
    print("cjm-error-handling not installed - skipping example")
```


    Example 2: WAIT_FOR_JOB -> ResourceError
      Error type: ResourceError
      Message: GPU in use by running job (PID 54321). Wait for completion or cancel job.
      Retryable: True
      Resource type: GPU
      Suggested action: Wait for current job to complete or cancel it
      Context worker PID: 54321

``` python
# Example 3: Practical usage pattern - raise error if validation fails
if _has_error_handling:
    print("\nExample 3: Practical Usage Pattern")
    print("="*60)
    
    def start_job_with_validation(plugin_id, job_id, validation_result):
        """Example function showing how to use validation + errors together."""
        # Check if we can proceed
        if not validation_result.can_proceed:
            # Convert to error and raise
            error = validation_result_to_error(
                validation_result,
                plugin_id=plugin_id,
                job_id=job_id
            )
            raise error
        
        # Validation passed, proceed with job
        return f"Job {job_id} started successfully with {plugin_id}"
    
    # Test with ABORT case
    try:
        result = ValidationResult(
            action=ValidationAction.ABORT,
            can_proceed=False,
            message="Plugin not found"
        )
        start_job_with_validation("whisper_huge", "job-789", result)
    except ValidationError as e:
        print(f"Caught ValidationError: {e.get_user_message()}")
        print(f"  Action: Don't retry, fix the plugin ID")
    
    # Test with WAIT_FOR_JOB case (retryable)
    try:
        result = ValidationResult(
            action=ValidationAction.WAIT_FOR_JOB,
            can_proceed=False,
            message="GPU busy"
        )
        start_job_with_validation("whisper_base", "job-999", result)
    except ResourceError as e:
        print(f"\nCaught ResourceError: {e.get_user_message()}")
        print(f"  Retryable: {e.is_retryable}")
        print(f"  Action: Retry after GPU becomes available")
    
    print("\n" + "="*60)
else:
    print("cjm-error-handling not installed - skipping example")
```


    Example 3: Practical Usage Pattern
    ============================================================
    Caught ValidationError: Plugin not found
      Action: Don't retry, fix the plugin ID

    Caught ResourceError: GPU busy
      Retryable: True
      Action: Retry after GPU becomes available

    ============================================================
